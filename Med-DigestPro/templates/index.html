<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Med-Digest Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); padding: 0.8rem; }
        .navbar-brand { font-weight: 700; color: white !important; letter-spacing: 0.5px; text-decoration: none; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.03); margin-bottom: 20px; background: white; }
        .card-header { background: white; border-bottom: 1px solid #eee; font-weight: 600; color: #0d6efd; padding: 15px; }
        .sticky-summary { position: sticky; top: 20px; max-height: 90vh; overflow-y: auto; }
        
        /* Akordiyon Tasarımı */
        details { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; background: #fff; }
        summary { background-color: #f8f9fa; padding: 12px 15px; cursor: pointer; font-weight: 600; color: #333; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; font-size: 1.2em; color: #0d6efd; font-weight: bold; }
        details[open] summary::after { content: '-'; }
        details[open] summary { border-bottom: 1px solid #e0e0e0; background-color: #eef2ff; color: #0d6efd; }
        .details-content { padding: 15px; font-size: 0.95em; line-height: 1.6; color: #555; }
        
        .article-link { text-decoration: none; color: #2c3e50; font-weight: 700; font-size: 1.05em; }
        .article-link:hover { color: #0d6efd; }
        .btn-search { background-color: #0d6efd; color: white; font-weight: 600; padding: 10px; border-radius: 8px; transition: 0.2s; }
        .btn-search:hover { background-color: #0b5ed7; transform: translateY(-1px); }
        .btn-reset { background-color: #e9ecef; color: #495057; font-weight: 600; padding: 10px; border-radius: 8px; text-decoration: none; display: inline-block; text-align: center; }
        .btn-reset:hover { background-color: #dee2e6; color: #212529; }
        .loader { display: none; }
        
        /* Ses Oynatıcı Stili */
        .audio-controls { background: #f8f9fa; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border: 1px solid #e9ecef; }
    </style>
</head>
<body>

<nav class="navbar mb-4 shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand" href="/"><i class="fas fa-dna me-2"></i>Med-Digest Pro</a>
        <span class="text-white small opacity-75 d-none d-md-block"><i class="fas fa-server me-1"></i>{{ active_model }}</span>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="row">
        
        <div class="col-lg-3 d-none d-lg-block">
            <div class="sticky-summary">
                <div class="card border-top border-primary border-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-brain me-2"></i>Analiz Raporu</span>
                    </div>
                    <div class="card-body p-2">
                        {% if result %}
                            <div class="audio-controls">
                                <button onclick="toggleSpeech()" id="btnSpeak" class="btn btn-sm btn-outline-primary rounded-circle" style="width: 35px; height: 35px;">
                                    <i class="fas fa-play"></i>
                                </button>
                                <select id="speechRate" class="form-select form-select-sm" style="width: auto;">
                                    <option value="1">1x (Normal)</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x (Hızlı)</option>
                                    <option value="2">2.0x</option>
                                </select>
                                <small class="text-muted ms-auto" style="font-size: 0.75em;">Sesli Özet</small>
                            </div>

                            <div id="aiSummaryRaw" style="display:none;">{{ result }}</div>
                            <div id="aiSummaryFormatted"></div>
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                <p class="small">Bir arama yaptığınızda yapay zeka buraya karşılaştırmalı analiz raporunu getirecek.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card p-4">
                <form method="POST" onsubmit="document.getElementById('loader').style.display='block'">
                    <div class="row g-2 mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Araştırma Konusu</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" name="query" class="form-control border-start-0 ps-0" 
                                       placeholder="Hastalık, ilaç veya tedavi..." value="{{ query }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 mb-3 align-items-end">
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Hedef Kitle</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="persona" id="p_doktor" value="Doktor" {{ 'checked' if persona == 'Doktor' else '' }}>
                                <label class="btn btn-outline-primary btn-sm" for="p_doktor">Doktor</label>
                                <input type="radio" class="btn-check" name="persona" id="p_hasta" value="Hasta" {{ 'checked' if persona == 'Hasta' else '' }}>
                                <label class="btn btn-outline-success btn-sm" for="p_hasta">Hasta</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Başlangıç</label>
                            <input type="number" name="start_year" class="form-control form-control-sm" placeholder="2020" value="{{ start_year }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Bitiş</label>
                            <input type="number" name="end_year" class="form-control form-control-sm" placeholder="2025" value="{{ end_year }}">
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-8">
                            <button class="btn btn-search w-100" type="submit">Analiz Et</button>
                        </div>
                        <div class="col-4">
                            <a href="/" class="btn btn-reset w-100"><i class="fas fa-redo me-1"></i>Temizle</a>
                        </div>
                    </div>
                </form>
            </div>

            <div id="loader" class="text-center my-4 loader">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted small">Literatür taranıyor...</p>
            </div>

            {% if error %}
            <div class="alert alert-danger shadow-sm small">{{ error }}</div>
            {% endif %}

            <div class="d-lg-none mb-4">
                {% if result %}
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">Genel Analiz</div>
                    <div class="card-body">
                         <div class="ai-mobile-output" style="white-space: pre-wrap;">{{ result }}</div>
                    </div>
                </div>
                {% endif %}
            </div>

            {% if articles %}
            <h6 class="mb-3 text-secondary fw-bold text-uppercase small ps-1"><i class="fas fa-stream me-2"></i>Bulunan Çalışmalar</h6>
            {% for art in articles %}
            <div class="card p-3 article-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <a href="{{ art.link }}" target="_blank" class="article-link lh-sm">{{ art.title }}</a>
                    <span class="badge bg-light text-dark border ms-2">{{ art.year }}</span>
                </div>
                <p class="text-muted small mb-3">{{ art.abstract[:280] }}...</p>
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ art.link }}" target="_blank" class="btn btn-sm btn-light text-muted border"><i class="fas fa-external-link-alt me-1"></i>Kaynak</a>
                    <button class="btn btn-sm btn-outline-info text-dark border-info" 
                            onclick="analyzeSingle(this)"
                            data-title="{{ art.title }}"
                            data-abstract="{{ art.abstract }}"
                            data-persona="{{ persona }}">
                        <i class="fas fa-microscope me-1"></i> İncele
                    </button>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <div class="col-lg-3">
            <div class="card">
                <div class="card-header bg-white text-warning"><i class="fas fa-history me-2"></i>Son Aramalar</div>
                <div class="list-group list-group-flush">
                    {% if history %}
                        {% for log in history %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-3 py-2">
                            <div class="text-truncate" style="max-width: 80%;">
                                <div class="fw-bold small text-dark">{{ log.query }}</div>
                                <div class="text-muted" style="font-size: 0.7em">{{ log.date.strftime('%d.%m') }} • {{ log.persona }}</div>
                            </div>
                            <a href="/download/{{ log.id }}" class="text-danger" title="PDF İndir"><i class="fas fa-file-pdf"></i></a>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-4 text-center text-muted small">Henüz kayıt yok.</div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white"><i class="fas fa-globe-americas me-2"></i>NY Times Health</div>
                <div class="list-group list-group-flush">
                    {% for news in news_list %}
                    <a href="{{ news.link }}" target="_blank" class="list-group-item list-group-item-action px-3 py-3">
                        <small class="d-block text-success fw-bold mb-1" style="font-size: 0.7em">{{ news.published }}</small>
                        <div class="text-dark small fw-semibold lh-sm">{{ news.title }}</div>
                    </a>
                    {% endfor %}
                </div>
                <div class="card-footer bg-white text-center p-1">
                    <small class="text-muted" style="font-size: 0.65em">Canlı RSS Akışı</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-dark border-0">
                <h6 class="modal-title fw-bold"><i class="fas fa-robot me-2"></i>Makale Analizi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div id="modalLoader" class="text-center py-4"><div class="spinner-border text-info"></div><p class="mt-2 small">İnceleniyor...</p></div>
                <div id="modalContentFormatted"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // SESLİ OKUMA FONKSİYONLARI
    let isSpeaking = false;
    let synth = window.speechSynthesis;
    let utterance = null;

    function toggleSpeech() {
        if (isSpeaking) {
            synth.cancel();
            isSpeaking = false;
            document.getElementById('btnSpeak').innerHTML = '<i class="fas fa-play"></i>';
        } else {
            // Metni temizle (markdown işaretlerini kaldır)
            let rawText = document.getElementById('aiSummaryRaw').innerText;
            // Başlık işaretlerini (#), yıldızları (*) ve garip karakterleri temizle
            let cleanText = rawText.replace(/###/g, '').replace(/\*\*/g, '').replace(/-/g, '');
            
            utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'tr-TR';
            utterance.rate = parseFloat(document.getElementById('speechRate').value);
            
            utterance.onend = function() {
                isSpeaking = false;
                document.getElementById('btnSpeak').innerHTML = '<i class="fas fa-play"></i>';
            };

            synth.speak(utterance);
            isSpeaking = true;
            document.getElementById('btnSpeak').innerHTML = '<i class="fas fa-stop"></i>';
        }
    }

    // FORMATLAYICI
    function formatAIResponse(rawText, targetDivId) {
        if (!rawText) return;
        let parts = rawText.split('###');
        let html = '';
        if (parts[0].trim()) {
            html += `<div class="p-3 mb-3 bg-white rounded border border-light shadow-sm text-dark small">${parts[0].replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</div>`;
        }
        for (let i = 1; i < parts.length; i++) {
            let section = parts[i].trim();
            let firstLineEnd = section.indexOf('\n');
            let title = section.substring(0, firstLineEnd > -1 ? firstLineEnd : section.length).trim();
            let content = firstLineEnd > -1 ? section.substring(firstLineEnd).trim() : '';
            content = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/^\* (.*$)/gm, '<li class="mb-1">$1</li>').replace(/\n/g, '<br>');
            html += `<details><summary>${title}</summary><div class="details-content bg-white">${content}</div></details>`;
        }
        document.getElementById(targetDivId).innerHTML = html;
    }

    document.addEventListener("DOMContentLoaded", function() {
        const rawSummary = document.getElementById('aiSummaryRaw');
        if (rawSummary) formatAIResponse(rawSummary.innerText, 'aiSummaryFormatted');
    });

    function analyzeSingle(btn) {
        const title = btn.getAttribute('data-title');
        const abstract = btn.getAttribute('data-abstract');
        const persona = btn.getAttribute('data-persona');
        var myModal = new bootstrap.Modal(document.getElementById('analysisModal'));
        document.getElementById('modalLoader').style.display = 'block';
        document.getElementById('modalContentFormatted').innerHTML = '';
        myModal.show();
        fetch('/analyze_article', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title: title, abstract: abstract, persona: persona})
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalLoader').style.display = 'none';
            formatAIResponse(data.analysis, 'modalContentFormatted');
        });
    }
</script>

</body>
</html>